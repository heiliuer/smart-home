C51 COMPILER V9.55   SMARTHOME                                                             07/25/2016 22:45:56 PAGE 1   


C51 COMPILER V9.55, COMPILATION OF MODULE SMARTHOME
OBJECT MODULE PLACED IN .\Objects\smarthome.obj
COMPILER INVOKED BY: D:\Program Files (x86)\Keil_v5\C51\BIN\C51.EXE smarthome.c OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXT
                    -END PRINT(.\Listings\smarthome.lst) TABS(2) OBJECT(.\Objects\smarthome.obj)

line level    source

   1          #include<reg52.h>               
   2          
   3          //函数声明 
   4          void SendStr(unsigned char *s);
   5          void DelayUs2x(unsigned char t);
   6          void DelayMs(unsigned char t);
   7          void sendIOData();
   8          
   9          unsigned int times = 0;
  10          
  11          unsigned char send[5];
  12          
  13          sbit KEY1 = P0 ^ 0;  //定义按键输入端口
  14          sbit KEY2 = P0 ^ 1;  //定义按键输入端口
  15          sbit LED1 = P1 ^ 0;
  16          sbit LED2 = P1 ^ 1;
  17          int flag1 = 1;
  18          int flag2 = 1;
  19          
  20          /*------------------------------------------------
  21           串口初始化
  22           ------------------------------------------------*/
  23          void InitUART(void) {
  24   1        SCON = 0x50;            // SCON: 模式 1, 8-bit UART, 使能接收  
  25   1        TMOD |= 0x20;               // TMOD: timer 1, mode 2, 8-bit 重装
  26   1        TH1 = 0xFD;               // TH1:  重装值 9600 波特率 晶振 11.0592MHz  
  27   1        TR1 = 1; //启动定时器                
  28   1        EA = 1;                  //打开总中断
  29   1        ES = 1;                  //打开串口中断
  30   1      }
  31          void SendByte(unsigned char dat);
  32          
  33          void checkbtn();
  34          void checkToggle();
  35          /*------------------------------------------------
  36           主函数
  37           ------------------------------------------------*/
  38          
  39          void main(void) {
  40   1        int i = 100;
  41   1        InitUART();
  42   1      
  43   1        //先输出0，再输出1，才能真正输出
  44   1        P0 = 0x00;
  45   1        P1 = 0x00;
  46   1        P2 = 0x00;
  47   1        P3 = 0x00;
  48   1      
  49   1        P0 = 0xff;
  50   1        P1 = 0xff;
  51   1        P2 = 0xff;
  52   1        P3 = 0xff;
  53   1      
  54   1        KEY1 = 1; //按键输入端口电平置高
C51 COMPILER V9.55   SMARTHOME                                                             07/25/2016 22:45:56 PAGE 2   

  55   1        KEY2 = 1;
  56   1      
  57   1      //    SendByte(0xff);
  58   1      //    while(i-->0){
  59   1      //      j=100;
  60   1      //      while(j-->0);
  61   1      //    }
  62   1        checkToggle();
  63   1        //主循环中添加其他需要一直工作的程序
  64   1      }
  65          
  66          //检测触发器模块
  67          void checkToggle() {
  68   1        flag1 = KEY1;
  69   1        flag2 = KEY2;
  70   1        while (1) {
  71   2          if (flag1 ^ KEY1) {
  72   3            flag1 = KEY1;
  73   3            LED1 = !LED1;
  74   3            sendIOData();
  75   3          }
  76   2          if (flag2 ^ KEY2) {
  77   3            flag2 = KEY2;
  78   3            LED2 = !LED2;
  79   3            sendIOData();
  80   3          }
  81   2        }
  82   1      }
  83          
  84          //检测两个按键
  85          void checkbtn() {
  86   1        while (1) {
  87   2      
  88   2          if (!KEY1 || !KEY2)  //如果检测到低电平，说明按键按下
  89   2              {
  90   3            DelayMs(10); //延时去抖，一般10-20ms
  91   3            if (!KEY1 || !KEY2)     //再次确认按键是否按下，没有按下则退出
  92   3                {
  93   4              flag1 = !KEY1;
  94   4              flag2 = !KEY2;
  95   4              while (!KEY1 || !KEY2)
  96   4                ;     //如果确认按下按键等待按键释放，没有释放则一直等待
  97   4      
  98   4              if (flag1) {
  99   5                LED1 = !LED1;
 100   5              }
 101   4              if (flag2) {
 102   5                LED2 = !LED2;
 103   5              }
 104   4              sendIOData();
 105   4      
 106   4            }
 107   3          }
 108   2        }
 109   1      }
 110          
 111          /*------------------------------------------------
 112           发送一个字节
 113           ------------------------------------------------*/
 114          void SendByte(unsigned char dat) {
 115   1        SBUF = dat;
 116   1        while (!TI)
C51 COMPILER V9.55   SMARTHOME                                                             07/25/2016 22:45:56 PAGE 3   

 117   1          ;
 118   1        TI = 0;
 119   1      }
 120          /*------------------------------------------------
 121           发送一个字符串
 122           ------------------------------------------------*/
 123          void SendStr(unsigned char *s) {
 124   1        while (*s != '\n')     // \0 表示字符串结束标志，通过检测是否字符串末尾
 125   1        {
 126   2          SendByte(*s);
 127   2          s++;
 128   2        }
 129   1      }
 130          
 131          void receive_wait() {
 132   1        while (!RI)
 133   1          ;
 134   1        RI = 0;
 135   1      }
 136          
 137          void sendIOData() {
 138   1        send[0] = P0;
 139   1        send[1] = P1;
 140   1        send[2] = P2;
 141   1        send[3] = P3;
 142   1        send[4] = '\n';
 143   1        SendStr(send);
 144   1      }
 145          
 146          /*------------------------------------------------
 147           串口数据 控制组件
 148           ------------------------------------------------*/
 149          void UART_SER()
 150          interrupt 4
 151          {
 152   1        if(RI)                        //判断是接收中断产生
 153   1        {
 154   2          RI=0;                      //标志位清零
 155   2          switch(SBUF) {
 156   3            case 0xaa:                      //读取所有IO口的电平状态
 157   3            receive_wait();
 158   3            sendIOData();
 159   3            break;
 160   3            case 0xa0://设置P0的8位电平
 161   3            receive_wait();
 162   3            P0=SBUF;
 163   3            sendIOData();
 164   3            break;
 165   3            case 0xa1://设置P1的8位电平
 166   3            receive_wait();
 167   3            P1=SBUF;
 168   3            flag1 = KEY1;
 169   3            flag2 = KEY2;
 170   3            sendIOData();
 171   3            break;
 172   3            case 0xa2://设置P2的8位电平
 173   3            receive_wait();
 174   3            P2=SBUF;
 175   3            sendIOData();
 176   3            break;
 177   3            case 0xa3://设置P3的8位电平
 178   3            receive_wait();
C51 COMPILER V9.55   SMARTHOME                                                             07/25/2016 22:45:56 PAGE 4   

 179   3            P3=P3&0x03|SBUF;
 180   3            sendIOData();
 181   3            break;
 182   3          }
 183   2        }
 184   1      //  if(TI)                        //如果是发送标志位，清零
 185   1      //  {
 186   1      //    TI=0;
 187   1      //  }
 188   1      }
 189          
 190          /*------------------------------------------------
 191           uS延时函数，含有输入参数 unsigned char t，无返回值
 192           unsigned char 是定义无符号字符变量，其值的范围是
 193           0~255 这里使用晶振12M，精确延时请使用汇编,大致延时
 194           长度如下 T=tx2+5 uS 
 195           ------------------------------------------------*/
 196          void DelayUs2x(unsigned char t) {
 197   1        while (--t)
 198   1          ;
 199   1      }
 200          /*------------------------------------------------
 201           mS延时函数，含有输入参数 unsigned char t，无返回值
 202           unsigned char 是定义无符号字符变量，其值的范围是
 203           0~255 这里使用晶振12M，精确延时请使用汇编
 204           ------------------------------------------------*/
 205          void DelayMs(unsigned char t) {
 206   1      
 207   1        while (t--) {
 208   2          //大致延时1mS
 209   2          DelayUs2x(245);
 210   2          DelayUs2x(245);
 211   2        }
 212   1      }
 213          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    406    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     11       2
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
